rm(list = ls())
##### phyloseq ######

library(phyloseq)

#read data
otudata <- read.csv("normal_otu.csv", header = TRUE)
otutax <- read.csv("taxa_divided.csv")
samdata <- read.csv("MetaData.csv")


#change row labels
#install.packages("tidyverse")
library(tidyverse)

otudata$OTU_ID <- sub(otudata$OTU_ID, 
                  pattern = "OTU", replacement = "")

otu_data <- otudata %>% remove_rownames %>% column_to_rownames(var="OTU_ID")


otutax$OTU_ID <- sub(otutax$OTU_ID, 
                     pattern = "OTU", replacement = "")

otu_taxa <- otutax %>% remove_rownames %>% column_to_rownames(var="OTU_ID")

#rownames(samdata) <-samdata$Label

sam_data<- samdata %>% remove_rownames %>% column_to_rownames(var="Site")

#coerce matrix (taxa needs to be in a matrix format)

test <- as.matrix(otu_taxa, rownames.force = NA)

# setting data to phyloseq format

library(phyloseq)
OTU <- otu_table(otu_data, taxa_are_rows = TRUE)
TAX <-  tax_table(test)
SAM <- sample_data(sam_data)


# combine physeq tables into 1 unit
table <- phyloseq(OTU, TAX)

physeq1 <- merge_phyloseq(table, SAM)


##### alpha visualization #####
alpha_meas = c("Shannon")

p <- plot_richness(physeq1, x="Treatment.Divided", measures=alpha_meas, color = "Treatment.Divided")+
  labs(title = "Alpha Diversity Measurment by Treatment" , caption = "")

p

p + geom_boxplot(data = p$data, aes(x=Treatment.Divided, y=value, color = NULL), alpha=0.05) +scale_x_discrete(limits = labels) +
  xlab("Treatment") +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = "white"),
        panel.border = element_rect(color = "black", fill = NA, size = 0.5),
        plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5, size = 10), 
        axis.title.x = element_text(color="black", vjust=1),
        axis.title.y = element_text(color="black" , vjust=1))+
  theme(strip.background = element_rect(colour="black", fill="white",
                                        size=0.5, linetype="solid"))
 

# change position in figure
labels <- c("Control - Chronic N", "Control - OakRecip", "Nitrogen ", "Control - SWaN", "Nitrogen/Invaded ", "Warm/Invaded ", "Control (GM)", "Invaded ", "Control (Warm PH/SWaN)", "Warm " )
p <- ggplot(theTable, aes(x = Position)) + scale_x_discrete(limits = labels)

##### alpha ANOVA ####

#https://rpubs.com/lconteville/713954
richness <- estimate_richness(physeq1)

# #Analysis of Variance of shannon alpha diversity compared to variables
anova.sh = aov(richness$Shannon ~ sample_data(physeq1)$Treatment.Divided)
summary(anova.sh)

#Tukey Honest Significant Differences -- confidence intervals between differences of the means of factors

TukeyHSD(anova.sh)


# library(vegan)
# 
# 
# otu_t <- t(otu_data)
# 
# write.csv(alphaotu, "alpha_otu.csv")
# 
# t_otu <- read.csv("transpose_otu.csv", header = TRUE)
# 
# t_otu$X <- sub(t_otu$X, 
#                  pattern = "OTU", replacement = "")
# 
# t_otu <- t_otu %>% remove_rownames %>% column_to_rownames(var="X")
# 
# 
# t_otu$Alpha <- diversity(t_otu,
#                             MARGIN = 1,
#                             index = "shannon")
# alpha_otu <- t(t_otu)
# 
# alphaotu <- as.data.frame(alpha_otu)
# 
# otu_year_group <- read.csv("Finalized_Metadata.csv")
# 
# 
# #Analysis of Variance of shannon alpha diversity compared to variables
# mixed_alpha <- aov(Alpha ~ Grouped, data = otu_year_group)
# summary(mixed_alpha)
# 
# #Tukey Honest Significant Differences -- confidence intervals between differences of the means of factors
# TukeyHSD(mixed_alpha)
# 
# write.csv(otuall.t, "otu_alpha_2.csv", row.names =TRUE)


#### Chao Shannon ####
library(iNEXT)

ChaoShannon <- ChaoShannon(otu_data, datatype = "abundance")
write.csv(ChaoShannon, "ChaoShannon.csv")

shannon <- read.csv("ChaoShannon.csv", header = TRUE)

#Analysis of Variance of shannon alpha diversity compared to variables
Chao <- aov(Observed ~ Grouped, data = shannon)
summary(Chao)

#Tukey Honest Significant Differences -- confidence intervals between differences of the means of factors
TukeyHSD(Chao)


##### beta visualization ####

#install.packages("betapart")
library(betapart)
library(vegan)
library(data.table)
library(dplyr)
library(tidyverse)

## MDS ##
t_otu <- t(otu_data)

t_otu <- as.data.frame(t_otu)

beta.data <- bray.part(t_otu)

mds<- metaMDS(beta.data$bray)

mds_data <- as.data.frame(mds$points)

# stress =0.1451684


mds_data$SampleID <- rownames(mds_data)
sam_data$SampleID <- rownames(sam_data)
mds_data <- dplyr::left_join(mds_data, sam_data)


# create palette
#install.packages("RColorBrewer")
library(RColorBrewer)
brewer.pal(10, "Spectral")
library(randomcoloR)
n <- 10
palette <- distinctColorPalette(n)
cbbPalette <- c("#9E0142", "#D53E4F" ,"#F46D43", "#FDAE61", "#FEE08B", "#E6F598" ,"#ABDDA4", "#66C2A5", "#3288BD", "#5E4FA2")


#plot
library(ggplot2)
p <- ggplot(mds_data, aes(x = MDS1, y = MDS2, color = Treatment.Divided )) +
  geom_point(size= 3)+
  stat_ellipse(size =.5) +
  theme(panel.grid = element_blank(),
        panel.background = element_rect(fill = "white"),
        panel.border = element_rect(color = "black", fill = NA, size = 0.5),
        plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0),
        axis.title.x = element_text(color="black", vjust=1),
        axis.title.y = element_text(color="black" , vjust=1))+
  scale_color_manual(values = palette) +
  theme(strip.background = element_rect(colour="black", fill="white",
                                        size=0.5, linetype="solid"))


#add plot labels
p + labs(title = "",
              caption = "")


##### permanova #####
#install.packages("PERMANOVA")

library(PERMANOVA)

#change lables
t_otu$SampleID <- rownames(t_otu)
sam_data$SampleID <- rownames(sam_data)
group_data <- dplyr::left_join(t_otu, sam_data)

#make groupes
groups <- factor(group_data$Grouped)
groups

#bray analysis
bray <- DistContinuous(t_otu, coef="Bray_Curtis")

permanova <- PERMANOVA(bray, groups, CoordPrinc = TRUE)

plot(permanova)

summary(permanova)


##### betadisper ##### 
#https://cran.r-project.org/web/packages/hagis/vignettes/betadiversity.html

#change labels
t_otu$SampleID <- rownames(t_otu)
sam_data$SampleID <- rownames(sam_data)
group_data <- dplyr::left_join(t_otu, sam_data)

# make gouping
groups <- factor(group_data$Grouped)
groups

dis <- vegdist(t_otu, "bray", na.rm = TRUE)

beta_dis <- betadisper(dis, group_data$Grouped)

beta_dis_anova <- anova(beta_dis) 
beta_dis_anova

beta_dis_TukeyHSD <- TukeyHSD(beta_dis)
beta_dis_TukeyHSD

boxplot(beta_dis,ellipse = TRUE)


###### taxa visualization ######

#https://rstudio-pubs-static.s3.amazonaws.com/403427_6537014d60e44e1b9d72514d5fb787b5.html

#https://www.nicholas-ollberding.com/post/introduction-to-the-statistical-analysis-of-microbiome-data-in-r/

plot_bar(physeq1, x="Grouped", fill="family") + theme(legend.position = "none")

plot_bar(physeq1, "Grouped", fill="order") + geom_bar(stat="identity") + theme(legend.position = "none")
